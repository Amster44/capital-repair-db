# Инструкция по импорту данных Capital Repair Database

## Быстрый старт

### Полный импорт всех регионов ПФО

```bash
python scripts/import_all_pfo.py
```

Этот скрипт автоматически:
1. Импортирует дома и лифты из всех регионов ПФО
2. Импортирует УК и создает связи дом-УК
3. Импортирует контакты (телефоны, email) из реестра
4. Выводит финальную статистику

## Пошаговый импорт

### Шаг 1: Импорт домов и лифтов (один регион)

```bash
python scripts/import_csv.py
```

Файлы: `data/regions/{region_code}/*.csv`

### Шаг 2: Импорт УК из ОЖФ

```bash
python -c "from scripts.import_uk_from_ojf import import_uk_from_ojf; import_uk_from_ojf('data/ojf_data/filename.csv')"
```

Или для всех файлов региона:

```python
from scripts.import_uk_from_ojf import import_uk_from_ojf
import glob

files = glob.glob('data/ojf_data/Сведения по ОЖФ Татарстан*.csv')
for file in files:
    import_uk_from_ojf(file)
```

### Шаг 3: Импорт контактов

```bash
python scripts/import_contacts_from_registry.py
```

Файл: `Реестр поставщиков информации от  2026-02-02.xlsx`

## Структура данных

### Источники

```
data/
├── regions/          # CSV с домами и лифтами
│   ├── 02_bashkortostan/
│   ├── 12_mariy-el/
│   ├── 16_tatarstan/
│   └── ...
├── ojf_data/         # CSV ОЖФ с данными УК
│   ├── Сведения по ОЖФ Татарстан Респ на 25-01-2026_1.csv
│   ├── Сведения по ОЖФ Татарстан Респ на 25-01-2026_2.csv
│   └── ...
└── uk_data/          # Excel с базовыми данными УК (опционально)
    └── Сведения по субъекту Татарстан Республика на 02.02.2026.xlsx

Реестр поставщиков информации от  2026-02-02.xlsx  # В корне проекта
```

### Таблицы БД

```
buildings                 # Дома (17,940 для Татарстана)
├── id
├── address
├── houseguid           # ФИАС GUID для связи с ОЖФ
├── overhaul_funds_balance  # Баланс ФКР (в тысячах рублей)
└── spec_account_owner_type  # UK, TSJ, JSK, REGOP

lifts                    # Лифты (17,987 для Татарстана)
├── id
├── building_id         # → buildings.id
├── decommissioning_date  # Срок замены
└── ...

management_companies     # УК (1,317 всего)
├── id
├── name
├── inn
├── ogrn
├── phone               # Из реестра
├── email               # Из реестра
└── director_name       # Обычно NULL

buildings_management     # Связи дом-УК (many-to-many)
├── building_id         # → buildings.id
└── company_id          # → management_companies.id
```

## Текущая статистика (Татарстан)

- **Дома**: 17,940
- **Лифты**: 17,987
- **УК**: 1,317
- **Покрытие домов УК**: 46.8% (улучшается после исправления)
- **УК с телефонами**: 93%
- **УК с email**: 97%

## Решенные проблемы

### ✅ Проблема 1: Неполное создание связей дом-УК

**Было**: Использовался `dict` для хранения связей → перезапись при дублях
**Стало**: Используется `set` для уникальных пар `(houseguid, ogrn)`

**Файл**: `scripts/import_uk_from_ojf.py`

### ✅ Проблема 2: Отсутствие контактов

**Решение**: Импорт из "Реестра поставщиков информации" по ИНН/ОГРН
**Результат**: 93% УК с телефонами, 97% с email

### ⚠️ Проблема 3: Отсутствие директоров

**Статус**: В реестре нет имен директоров, только должности
**Решение**: Поле `director_name` остается пустым (прочерк в интерфейсе)

## Известные ограничения

1. **Покрытие УК не 100%**
   - Некоторые дома на регоператоре (нет УК)
   - Некоторые данные отсутствуют в источниках

2. **Данные директоров**
   - В реестре нет имен директоров
   - Только для некоторых УК есть данные из других источников

3. **Европейская нумерация в CSV**
   - Пробелы как разделители тысяч: "1 234,56"
   - Обрабатывается скриптом `import_csv.py`

## Запуск приложения

После импорта данных:

1. **Backend** (Flask API):
   ```bash
   cd backend
   python api.py
   ```
   API: http://localhost:5000

2. **Frontend** (React):
   ```bash
   cd frontend
   npm start
   ```
   Интерфейс: http://localhost:3000

## Фильтры в интерфейсе

- **Регион**: Выбор региона ПФО
- **Тип счета**: Спецсчет (УК/ТСЖ/ЖСК) / Регоператор
- **Мин. баланс**: Фильтр по балансу ФКР
- **Срок замены лифтов**: 1/2/3/5 лет

## Поддержка

Документация:
- [IMPORT_LOGIC.md](IMPORT_LOGIC.md) - Подробная логика импорта
- [README.md](README.md) - Общее описание проекта
