# Логика импорта данных Capital Repair Database

## Текущее состояние

### Источники данных

1. **data/regions/** - CSV файлы с домами и лифтами (по регионам ПФО)
   - Формат: европейская нумерация (пробелы как разделители тысяч, запятые как десятичные)
   - Содержит: адреса домов, балансы ФКР, площади, типы счетов, данные о лифтах
   - Импортируется скриптом: `scripts/import_csv.py`
   - Статус: ✅ Работает корректно (17,940 домов, 17,987 лифтов для Татарстана)

2. **data/ojf_data/** - CSV файлы ОЖФ (Общежилфонд) по регионам
   - Формат: разделитель `|`
   - Содержит: данные об УК (название, ОГРН, КПП), связь дом-УК через houseguid
   - Импортируется скриптом: `scripts/import_uk_from_ojf.py`
   - Статус: ⚠️ Работает частично (покрытие 46.8% домов)

3. **data/uk_data/** - Excel файлы с данными УК по регионам
   - Формат: Excel (.xlsx)
   - Содержит: базовые данные УК (название, ИНН, ОГРН)
   - Импортируется скриптом: `scripts/import_uk_from_excel.py`
   - Статус: ⚠️ Использовался ранее, но данные неполные

4. **Реестр поставщиков информации от 2026-02-02.xlsx** - реестр с контактами
   - Формат: Excel
   - Содержит: телефоны и email организаций (не только УК!)
   - Импортируется скриптом: `scripts/import_contacts_from_registry.py`
   - Статус: ✅ Работает (93% УК с телефонами, 97% с email)

### Текущие проблемы

#### Проблема 1: Неполное создание связей дом-УК (46.8% покрытие)

**Причина:**
В скрипте `import_uk_from_ojf.py` используется словарь `house_to_company`:
```python
house_to_company = {}  # house_guid -> ogrn
```

Проблема: если в файле несколько записей для одного houseguid (например, разные помещения), то словарь перезаписывается, и сохраняется только последняя связь.

**Пример:**
```
420124, ... |50174524-f90e-4235-889b-1cffe6771228|...|1021603138732|...
420124, ... |50174524-f90e-4235-889b-1cffe6771228|...|1021603138732|...
```
→ Обе записи для одного дома, но связь создается только один раз (и может не создаться, если дом не найден по другим причинам)

#### Проблема 2: Импортированы только данные Татарстана

**Статус:**
- ✅ Татарстан: 17,940 домов
- ❌ Остальные 13 регионов ПФО: не импортированы

#### Проблема 3: Данные директоров отсутствуют

**Причина:** В реестре поставщиков информации нет имен директоров УК, только должности (типа "Товарищество собственников жилья")

**Решение:** Оставляем поле `director_name` пустым (прочерк)

## Улучшенная логика импорта

### Шаг 1: Импорт домов и лифтов (regions)
```
scripts/import_csv.py → data/regions/*.csv
```
- Парсинг европейской нумерации
- Импорт домов в таблицу `buildings`
- Импорт лифтов в таблицу `lifts`
- Связь через `building_id`

### Шаг 2: Импорт УК и связей (ojf_data) - ИСПРАВЛЕННАЯ ЛОГИКА
```
scripts/import_uk_from_ojf.py → data/ojf_data/*.csv
```
**ИЗМЕНЕНИЯ:**
1. Использовать `set` для хранения уникальных пар (houseguid, ogrn)
   ```python
   house_to_company = set()  # {(house_guid, ogrn), ...}
   ```
2. Создавать связь для каждой уникальной пары
3. Избегать дублирования через `ON CONFLICT DO NOTHING`

### Шаг 3: Импорт контактов (реестр)
```
scripts/import_contacts_from_registry.py → Реестр поставщиков информации
```
- Сопоставление по ИНН и ОГРН
- Обновление полей `phone` и `email`
- НЕ обновлять `director_name` (его нет в реестре)

## План действий

1. ✅ Исправить `scripts/import_uk_from_ojf.py` - использовать set вместо dict
2. ⏳ Создать мастер-скрипт `scripts/import_all_data.py` для импорта всех регионов
3. ⏳ Импортировать данные для всех 14 регионов ПФО
4. ⏳ Запустить импорт контактов для всех УК

## Финальная статистика (цель)

- Домов: ~50,000-100,000 (все регионы ПФО)
- Лифтов: ~50,000-100,000
- УК: ~2,000-3,000
- Покрытие домов УК: >80%
- УК с контактами: >90%
