# Диаграмма связей базы данных

## Основная схема связей

```
┌─────────────────────────┐
│       regions           │
│  (Регионы ПФО)          │
└───────┬─────────────────┘
        │
        │ 1:N
        ▼
┌─────────────────────────┐         ┌──────────────────────┐
│   municipalities        │         │  organization_types  │
│  (Муниципалитеты)       │         │  (УК/ТСЖ/ЖСК)        │
└───────┬─────────────────┘         └──────┬───────────────┘
        │                                   │
        │ 1:N                               │ 1:N
        ▼                                   ▼
┌─────────────────────────────────────────────────────────┐
│                    buildings                            │
│              (Многоквартирные дома)                     │
│  ┌────────────────────────────────────────────────┐    │
│  │ КЛЮЧЕВЫЕ ПОЛЯ:                                 │    │
│  │ - address (адрес)                              │    │
│  │ - spec_account_owner_type (УК/ТСЖ/ЖСК)        │    │
│  │ - overhaul_funds_balance (остаток средств) ★   │    │
│  │ - money_collecting_way (спецсчет/регоператор)  │    │
│  └────────────────────────────────────────────────┘    │
└────┬──────────────┬───────────────┬────────────────────┘
     │              │               │
     │ 1:N          │ 1:N           │ N:M
     ▼              ▼               ▼
┌──────────┐  ┌────────────┐  ┌─────────────────────┐
│  lifts   │  │construction│  │buildings_management │
│ (Лифты)  │  │ _elements  │  │ (связь дом ↔ УК)    │
│          │  │            │  └───────┬─────────────┘
│ ★ decom  │  │(крыши,     │          │
│ _date    │  │ фасады)    │          │ N:1
└──────────┘  └────────────┘          ▼
     │                     ┌────────────────────────────┐
     │ 1:N                 │  management_companies      │
     ▼                     │  (УК/ТСЖ)                  │
┌──────────┐               │  ┌──────────────────────┐ │
│ services │               │  │ КОНТАКТЫ:            │ │
│ (Работы) │               │  │ - name               │ │
│          │               │  │ - director_name ★    │ │
│ ★ подряд │               │  │ - phone ★            │ │
│ чики     │               │  │ - email ★            │ │
│          │               │  │ - inn                │ │
└──────────┘               │  └──────────────────────┘ │
                           └──────┬────────────────────┘
                                  │
                                  │ 1:N
                                  ▼
                           ┌──────────────┐
                           │  contacts    │
                           │ (Контактные  │
                           │   лица)      │
                           └──────────────┘
```

## CRM модуль (для работы команды)

```
┌─────────────────────────┐
│      buildings          │
│   (из основной БД)      │
└───────┬─────────────────┘
        │
        │ 1:N
        ▼
┌─────────────────────────┐         ┌──────────────────┐
│       deals             │◄────────│  deal_statuses   │
│     (Сделки)            │  N:1    │  (Статусы)       │
│  ┌──────────────────┐   │         │  - new           │
│  │ ПОЛЯ:            │   │         │  - in_contact    │
│  │ - potential_amt  │   │         │  - negotiation   │
│  │ - advance_amt    │   │         │  - contract      │
│  │ - lift_count     │   │         │  - won/lost      │
│  │ - probability_%  │   │         └──────────────────┘
│  └──────────────────┘   │
└───┬───────────┬─────────┘
    │           │
    │ 1:N       │ N:1
    ▼           ▼
┌──────────┐  ┌──────────────────┐
│activities│  │     users        │
│ (История │  │ (Менеджеры)      │
│  звонков,│  │                  │
│  встреч) │  │ - full_name      │
└──────────┘  │ - role           │
              │ - regions[]      │
              └──────────────────┘
                      │
                      │ 1:N
                      ▼
              ┌──────────────────┐
              │   audit_log      │
              │ (Журнал действий)│
              └──────────────────┘
```

## Поток данных

```
┌──────────────────────────────────────────────────────┐
│  ЭТАП 1: Импорт данных из CSV                        │
│  ┌────────────────────────────────────────────┐      │
│  │  CSV файлы (КР 1.1, 1.2, 1.3)              │      │
│  │         ↓                                  │      │
│  │  Python скрипт import_csv.py               │      │
│  │         ↓                                  │      │
│  │  PostgreSQL: buildings, lifts, services    │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────┐
│  ЭТАП 2: Парсинг данных об УК                        │
│  ┌────────────────────────────────────────────┐      │
│  │  API Реформа ЖКХ / ГИС ЖКХ                 │      │
│  │         ↓                                  │      │
│  │  Python скрипт parse_uk.py                 │      │
│  │         ↓                                  │      │
│  │  PostgreSQL: management_companies          │      │
│  │         ↓                                  │      │
│  │  Связывание: buildings ↔ companies         │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────┐
│  ЭТАП 3: Работа команды через веб-интерфейс          │
│  ┌────────────────────────────────────────────┐      │
│  │  1. Просмотр целевых домов (фильтры)       │      │
│  │  2. Создание сделок (deals)                │      │
│  │  3. Добавление контактов (contacts)        │      │
│  │  4. Запись звонков/встреч (activities)     │      │
│  │  5. Обновление статусов                    │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘
```

## Ключевые представления (Views)

### v_target_buildings - Целевые дома для продаж

**Показывает:**
- Дома со спецсчетами (УК/ТСЖ/ЖСК)
- Остаток средств ≥ 1.2 млн руб (минимальный аванс)
- Количество лифтов
- Срок до замены лифтов
- Контакты УК (телефон, email, директор)
- Статус сделки (если есть)
- Приоритет (HIGH/MEDIUM/LOW)

**Используется для:**
- Поиск новых клиентов
- Планирование звонков
- Отчеты по регионам

**Пример запроса:**
```sql
SELECT * FROM v_target_buildings
WHERE region_name = 'Республика Татарстан'
  AND priority = 'HIGH'
  AND deal_id IS NULL  -- еще нет сделки
ORDER BY overhaul_funds_balance DESC
LIMIT 50;
```

### v_sales_pipeline - Воронка продаж

**Показывает:**
- Распределение сделок по этапам
- Общая сумма на каждом этапе
- Средняя вероятность закрытия
- Менеджеры, работающие на этапе

**Используется для:**
- Мониторинг продаж
- KPI менеджеров
- Прогнозирование выручки

## Индексы для производительности

**Критичные для быстрого поиска:**

1. `idx_buildings_spec_account` - поиск домов со спецсчетами
2. `idx_buildings_balance` - сортировка по остатку средств
3. `idx_lifts_replacement` - поиск лифтов требующих замены
4. `idx_buildings_address` - полнотекстовый поиск по адресам
5. `idx_deals_status` - фильтрация по статусам сделок
6. `idx_companies_inn` - быстрый поиск УК по ИНН

## Оценка объема данных

### Приволжский федеральный округ (14 регионов):

| Таблица | Записей | Размер |
|---------|---------|--------|
| buildings | ~250,000 | ~150 МБ |
| lifts | ~500,000 | ~80 МБ |
| services | ~2,500,000 | ~600 МБ |
| construction_elements | ~800,000 | ~200 МБ |
| management_companies | ~10,000 | ~5 МБ |
| deals | ~5,000 | ~2 МБ |
| contacts | ~15,000 | ~3 МБ |
| activities | ~50,000 | ~15 МБ |
| **ИТОГО** | **~4.1 млн** | **~1 ГБ** |

**Вывод:** База среднего размера, PostgreSQL легко справится

## Безопасность данных

### Роли пользователей:

1. **admin** - полный доступ
2. **manager** - работа с deals, contacts, activities
3. **analyst** - только чтение + экспорт данных
4. **viewer** - только просмотр

### Аудит всех действий:

Таблица `audit_log` записывает:
- Кто (user_id)
- Что сделал (action)
- С какой записью (entity_type, entity_id)
- Когда (created_at)
- Изменения (old_values → new_values)

## Резервное копирование

Рекомендуется:
- Полный бэкап: ежедневно
- Инкрементный: каждые 4 часа
- Хранение: 30 дней

```bash
# Пример команды бэкапа
pg_dump -U postgres -d capital_repair_db > backup_$(date +%Y%m%d).sql
```
